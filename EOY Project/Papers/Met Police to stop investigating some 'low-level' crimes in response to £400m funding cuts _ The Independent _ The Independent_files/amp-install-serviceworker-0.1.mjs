;
(self.AMP=self.AMP||[]).push({m:1,v:"2206101637000",n:"amp-install-serviceworker",ev:"0.1",l:!0,f:function(t,e){(()=>{var{hasOwnProperty:e,toString:r}=Object.prototype;function n(t,e){void 0===e&&(e=t.hasAttribute("hidden")),e?t.removeAttribute("hidden"):t.setAttribute("hidden","")}self.__AMP_LOG=self.__AMP_LOG||{user:null,dev:null,userForEmbed:null};var i=self.__AMP_LOG;function s(t){return i.user||(i.user=o()),function(t,e){return e&&e.ownerDocument.defaultView!=t}(i.user.win,t)?i.userForEmbed||(i.userForEmbed=o()):i.user}function o(t){return function(t,e){throw new Error("failed to call initLogConstructor")}()}function c(t,e,r,n,i,s,o,c,a,l,h){return t}function a(t,e,r,n,i,o,c,a,l,h,u){return s().assert(t,e,r,n,i,o,c,a,l,h,u)}function l(t,e){return f(t=function(t){return t.__AMP_TOP||(t.__AMP_TOP=t)}(t),e)}function h(t){return t.nodeType?(r=t,e=(r.ownerDocument||r).defaultView,l(e,"ampdoc")).getAmpDoc(t):t;var e,r}function u(t){const e=h(t);return e.isSingleDoc()?e.win:e}function f(t,e){c(d(t,e));const r=function(t){let e=t.__AMP_SERVICES;return e||(e=t.__AMP_SERVICES={}),e}(t)[e];return r.obj||(c(r.ctor),c(r.context),r.obj=new r.ctor(r.context),c(r.obj),r.context=null,r.resolve&&r.resolve(r.obj)),r.obj}function d(t,e){const r=t.__AMP_SERVICES&&t.__AMP_SERVICES[e];return!(!r||!r.ctor)}var m,p=t=>function(t,e){const r=u(h(t));return d(r,"url")?f(r,"url"):null}(t);function v(t){const e=t.indexOf("#");return-1==e?t:t.substring(0,e)}new Set(["c","v","a","ad"]);var w=(()=>self.AMP.config.urls)(),_="amp-install-serviceworker",P=class extends t.BaseElement{constructor(t){var e;super(t),this.cv=null,this.av=null,this.lv=(e=this.win,l(e,"platform")).isSafari()}buildCallback(){const{win:t}=this;if(!("serviceWorker"in t.navigator))return void this.uv();const e=this.fv(),r=this.element.getAttribute("src");if(e.assertHttpsUrl(r,this.element),!e.isProxyOrigin(r)&&!e.isProxyOrigin(t.location.href)||this.lv)e.parse(t.location.href).origin==e.parse(r).origin?this.dv().then((()=>function(t,e,r){const n={};return r.hasAttribute("data-scope")&&(n.scope=r.getAttribute("data-scope")),t.navigator.serviceWorker.register(e,n).then((function(e){const n=e.installing;return n?n.addEventListener("statechange",(n=>{"activated"===n.target.state&&A(e,t,r)})):e.active&&A(e,t,r),e}),(function(t){s().error(_,"ServiceWorker registration failed:",t)}))}(this.win,r,this.element))):this.user().error(_,"Did not install ServiceWorker because it does not match the current origin: "+r);else{const t=this.element.getAttribute("data-iframe-src");if(t){e.assertHttpsUrl(t,this.element);const{origin:r}=e.parse(t),n=function(t,e){return f(u(h(t)),"documentInfo")}(this.element).get(),i=e.parse(n.sourceUrl),s=e.parse(n.canonicalUrl);a(r==i.origin||r==s.origin,"data-iframe-src (%s) should be a URL on the same origin as the source (%s) or canonical URL (%s) of the AMP-document.",r,i.origin,s.origin),this.cv=t,this.dv().then((()=>this.mv()))}}(e.isProxyOrigin(r)||e.isProxyOrigin(t.location.href))&&this.lv&&this.user().error(_,"Did not install ServiceWorker because of safari double keyring caching as it will not have any effect")}dv(){return Promise.all([this.loadPromise(this.win),this.getAmpDoc().whenFirstVisible()])}mv(){return this.mutateElement((()=>{n(this.element,!1);const t=this.win.document.createElement("iframe");t.setAttribute("sandbox","allow-same-origin allow-scripts"),t.src=this.cv,this.element.appendChild(t)}))}uv(){if(!this.getAmpDoc().isSingleDoc())return;const t=this.getAmpDoc(),{win:e}=this,r=this.fv(),n=r.parse(e.location.href),i=this.element.getAttribute("data-no-service-worker-fallback-url-match");let o,c=this.element.getAttribute("data-no-service-worker-fallback-shell-url");if(i||c){a(i&&c,'Both, "%s" and "%s" must be specified for url-rewrite',"data-no-service-worker-fallback-url-match","data-no-service-worker-fallback-shell-url"),c=v(c);try{o=new RegExp(i)}catch(t){throw s().createError('Invalid "data-no-service-worker-fallback-url-match" expression',t)}a(r.getSourceOrigin(n)==r.parse(c).origin,'Shell source origin "%s" must be the same as source origin "%s"',c,n.href),this.av=new k(t,o,c,this.element),r.isSecure(c)&&this.pv(c)}}pv(t){return this.dv().then((()=>{this.mutateElement((()=>this.vv(t)))}))}vv(t){const{win:e}=this,r=e.document.createElement("iframe");r.id="i-amphtml-shell-preload",r.setAttribute("src",t+"#preload"),n(r,!1),r.setAttribute("sandbox","allow-scripts allow-same-origin"),this.loadPromise(r).then((()=>{var t,e;null===(e=(t=r).parentElement)||void 0===e||e.removeChild(t)})),this.element.appendChild(r)}fv(){return p(this.element)}},k=class{constructor(t,e,r,n){this.win=t.win,this.wv=e,this._v=r,this.Pv=p(n),this.kv=this.Pv.parse(r),function(t,e,r,n){!function(t,e,r,n){let i=t,s=r;const o=function(){if(void 0!==m)return m;m=!1;try{const t={get capture(){return m=!0,!1}};self.addEventListener("test-options",null,t),self.removeEventListener("test-options",null,t)}catch(t){}return m}();i.addEventListener("click",(t=>{try{return s(t)}catch(t){var e,r;throw null===(e=(r=self).__AMP_REPORT_ERROR)||void 0===e||e.call(r,t),t}}),!!o&&n)}(t,0,r,void 0)}(t.getRootNode(),0,this.sd.bind(this))}sd(t){if(t.defaultPrevented)return;const e=t.target.closest("A");if(!e||!e.href)return;const r=this.Pv.parse(e.href);if(r.origin!=this.kv.origin||r.pathname==this.kv.pathname||!this.wv.test(r.href))return;if(e.getAttribute("i-amphtml-orig-href"))return;const{win:n}=this;v(r.href)!=v(n.location.href)&&(e.setAttribute("i-amphtml-orig-href",e.href),e.href=this._v+"#href="+encodeURIComponent(`${r.pathname}${r.search}${r.hash}`))}};function A(t,e,r){!function(t,e){if("performance"in t){const r=t.performance.getEntriesByType("resource").filter((t=>"script"===t.initiatorType&&t.name.startsWith(w.cdn))).map((t=>t.name)),n=e.active;n.postMessage&&n.postMessage(JSON.stringify({"type":"AMP__FIRST-VISIT-CACHING","payload":r}))}}(e,t),r.hasAttribute("data-prefetch")&&function(t,e){const{document:r}=e,n=[].map.call(r.querySelectorAll("a[data-rel=prefetch]"),(t=>t.href));if(function(t){const e=t.createElement("link");return!(!e.relList||!e.relList.supports)&&e.relList.supports("prefetch")}(r))n.forEach((t=>{const e=r.createElement("link");e.setAttribute("rel","prefetch"),e.setAttribute("href",t),r.head.appendChild(e)}));else{const e=t.active;e.postMessage&&e.postMessage(JSON.stringify({"type":"AMP__LINK-PREFETCH","payload":n}))}}(t,e)}t.registerElement(_,P)})();
/*! https://mths.be/cssescape v1.5.1 by @mathias | MIT license */}});
//# sourceMappingURL=amp-install-serviceworker-0.1.mjs.map